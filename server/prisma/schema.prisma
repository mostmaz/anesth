generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  SENIOR
  RESIDENT
  NURSE
}

enum ShiftType {
  DAY
  NIGHT
}

model User {
  id           String   @id @default(uuid())
  name         String
  username     String   @unique
  passwordHash String
  role         Role
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  shifts       Shift[]
  notes        ClinicalNote[]
  audits       AuditLog[]
  ioEntries    IntakeOutput[]
  checkIns     NurseCheckIn[]
  createdOrders ClinicalOrder[] @relation("CreatedOrders")
  approvedOrders ClinicalOrder[] @relation("ApprovedOrders")
  investigations Investigation[]
  specialistNotes SpecialistNote[]
  administeredMeds MedicationAdministration[]
  assignments  PatientAssignment[]
}

model PatientAssignment {
  id        String   @id @default(uuid())
  patientId String
  userId    String
  shiftId   String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  endedAt   DateTime?

  patient   Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id])
  shift     Shift?   @relation(fields: [shiftId], references: [id])
}

model Shift {
  id        String    @id @default(uuid())
  userId    String
  type      ShiftType
  startTime DateTime  @default(now())
  endTime   DateTime?
  isActive  Boolean   @default(true)

  user      User      @relation(fields: [userId], references: [id])
  ioEntries IntakeOutput[]
  checkIns  NurseCheckIn[]
  assignments PatientAssignment[]
}

model Patient {
  id        String   @id @default(uuid())
  mrn       String   @unique

  name      String
  dob       DateTime
  gender    String
  comorbidities String[] @default([])
  diagnosis     String?
  
  admissions  Admission[]
  notes       ClinicalNote[]
  vitals      VitalSign[]
  medications MedicationAdministration[]
  prescriptions Medication[]
  ioEntries   IntakeOutput[]
  checkIns    NurseCheckIn[]
  orders      ClinicalOrder[]
  investigations Investigation[]
  assignments    PatientAssignment[]
  specialistNotes SpecialistNote[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Admission {
  id        String   @id @default(uuid())
  patientId String
  bed       String?
  diagnosis String?
  admittedAt DateTime @default(now())
  dischargedAt DateTime?

  patient   Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)
}

// Clinical Notes
model ClinicalNote {
  id        String   @id @default(uuid())
  patientId String
  authorId  String
  
  type      NoteType
  title     String
  content   String   @db.Text
  data      Json?    // Structured data for procedures
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  patient   Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)
  author    User     @relation(fields: [authorId], references: [id])
}

enum NoteType {
  ADMISSION
  PROGRESS
  PROCEDURE
  DISCHARGE
  NURSING
  CONSULT
  OTHER
}


model AuditLog {
  id        String   @id @default(uuid())
  action    String
  details   String?
  userId    String
  timestamp DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id])
}

model VitalSign {
  id        String   @id @default(uuid())
  patientId String
  
  heartRate Int?
  bpSys     Int?
  bpDia     Int?
  spo2      Int?
  temp      Float?
  rbs       Float? // Random Blood Sugar
  
  timestamp DateTime @default(now())
  
  patient   Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)
}

model Medication {
  id          String   @id @default(uuid())
  name        String
  defaultDose String
  route       String   // e.g., IV, PO
  frequency   String?  // e.g., Q4H
  infusionRate String? // e.g., 5ml/hr
  otherInstructions String? // e.g., "Take with food"
  patientId   String?
  
  patient     Patient? @relation(fields: [patientId], references: [id], onDelete: Cascade)
  administrations MedicationAdministration[]
}

model DrugCatalog {
  id        String   @id @default(uuid())
  name      String   @unique
  defaultDose String?
  defaultRoute String?
  createdAt DateTime @default(now())
}


model MedicationAdministration {
  id           String   @id @default(uuid())
  patientId    String
  medicationId String
  
  status       String   // Scheduled, Given, Held, NotGiven
  dose         String?
  timestamp    DateTime @default(now())
  userId       String?  // Nurse who administered
  
  patient      Patient    @relation(fields: [patientId], references: [id], onDelete: Cascade)
  medication   Medication @relation(fields: [medicationId], references: [id])
  user         User?      @relation(fields: [userId], references: [id])
}


model IntakeOutput {
  id        String   @id @default(uuid())
  patientId String
  userId    String
  shiftId   String?

  type      String   // INPUT or OUTPUT
  category  String   // e.g., "IV Fluid", "Urine"
  amount    Float    // mL
  notes     String?
  timestamp DateTime @default(now())

  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)
  user      User    @relation(fields: [userId], references: [id])
  shift     Shift?  @relation(fields: [shiftId], references: [id])
}

model NurseCheckIn {
  id        String   @id @default(uuid())
  patientId String
  userId    String
  shiftId   String?

  airwaySafe    Boolean @default(true)
  breathingOk   Boolean @default(true)
  circulationOk Boolean @default(true)
  notes         String?
  timestamp     DateTime @default(now())

  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)
  user      User    @relation(fields: [userId], references: [id])
  shift     Shift?  @relation(fields: [shiftId], references: [id])
}

model Governorate {
  id        String   @id @default(uuid())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum OrderStatus {
  DRAFT
  PENDING
  APPROVED
  COMPLETED
  DISCONTINUED
}

enum OrderType {
  MEDICATION
  LAB
  IMAGING
  PROTOCOL
  NURSING
  DIET
  CONSULT
  PROCEDURE
}

enum Priority {
  ROUTINE
  URGENT
  STAT
}

model ClinicalOrder {
  id        String      @id @default(uuid())
  patientId String
  authorId  String      // Creator
  approverId String?    // Senior who approved
  
  type      OrderType
  status    OrderStatus @default(PENDING)
  priority  Priority    @default(ROUTINE)
  
  title     String      // e.g., "Furosemide 40mg IV"
  details   Json?       // Flexible data: { dose: "40mg", route: "IV" }
  notes     String?
  
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)
  author    User    @relation("CreatedOrders", fields: [authorId], references: [id])
  approver  User?   @relation("ApprovedOrders", fields: [approverId], references: [id])
  investigations Investigation[]
}

enum InvestigationStatus {
  PRELIMINARY
  FINAL
  AMENDED
}


model SpecialistNote {
  id        String   @id @default(uuid())
  patientId String
  authorId  String
  
  // Header
  date      DateTime @default(now())
  apacheScore String?
  
  // Background
  histHT    Boolean @default(false)
  histDM    Boolean @default(false)
  histAsthma Boolean @default(false)
  histCOPD  Boolean @default(false)
  histIHD   Boolean @default(false)
  histStroke Boolean @default(false)
  histOther String?

  // Neurological
  neuroGCS  String?
  neuroRASS String?

  // Ventilatory
  respChest String? // "Chest..."
  respRoomAir Boolean @default(false)
  respO2Therapy Boolean @default(false)
  respVentMode Boolean @default(false) // "Ventilatory mode"
  respVentModeText String? // The blank line after "Ventilatory mode"
  respFio2  String?
  respPS    String?

  // Interventions (Checkboxes)
  intCVLine    Boolean @default(false)
  intArtLine   Boolean @default(false)
  intETT       Boolean @default(false)
  intTrach     Boolean @default(false)
  intDoubleLumen Boolean @default(false)

  // Hydration
  hydNormovolemia Boolean @default(false)
  hydHypervolemia Boolean @default(false)
  hydHypovolemia  Boolean @default(false)
  hydUOP          String?
  hydIVC          String?
  hydCVP          String?

  // Hemodynamic
  hemoStable      Boolean @default(false)
  hemoUnstable    Boolean @default(false)
  hemoVasopressor Boolean @default(false)

  // Feeding & Fluids
  feedOral Boolean @default(false)
  feedNG   Boolean @default(false)
  feedTPN  Boolean @default(false)
  feedRate String? // ml/

  ivFluidsRate String? // ml/hr

  // Sedation
  sedPropofol Boolean @default(false)
  sedKetamine Boolean @default(false)
  sedMidazolam Boolean @default(false)
  sedRemif    Boolean @default(false)
  sedMR       Boolean @default(false) // Muscle Relaxant?
  sedOther    String?

  // Notes
  clinicalNotes String? @db.Text

  // Plan
  planVentilatory String?
  planPhysio      String?
  planConsult     String?
  planInvestigation String?
  planOther       String?
  planFuture      String?
  planHomeTeam    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)
  author    User    @relation(fields: [authorId], references: [id])
}

model Investigation {
  id        String    @id @default(uuid())
  patientId String
  orderId   String?
  authorId  String    // Person who entered/verified result
  
  type      OrderType // Reusing OrderType (LAB, IMAGING)
  category  String    // e.g. "Hematology", "CT Head"
  title     String    // e.g. "CBC", "Non-contrast CT"
  
  status    InvestigationStatus @default(FINAL)
  
  result    Json?     // Struct: { "Hb": 12.5, "WBC": 11.2 } for labs. Text or URL for imaging.
  impression String?  // Conclusion text
  
  conductedAt DateTime @default(now()) // When the test was done
  createdAt   DateTime @default(now()) // When it was entered in system
  
  externalId  String?   // Lab Accession Number (Not unique, can have multiple reports per AccNo)

  patient   Patient       @relation(fields: [patientId], references: [id], onDelete: Cascade)
  order     ClinicalOrder? @relation(fields: [orderId], references: [id])
  author    User          @relation(fields: [authorId], references: [id])
}

